name: Build and host documentation

on:
  merge_group:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - main

# Default permissions (individual jobs can override as needed)
permissions:
  contents: read

jobs:
  build:
    name: Build documentation
    runs-on: ubuntu-latest-16-cores
    if: github.event.action != 'closed'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: taiki-e/install-action@protoc

      - name: Build Documentation
        run: cargo doc --no-deps --all --all-features

      - name: Add index file
        run: |
          mkdir host-docs
          echo "<meta http-equiv=\"refresh\" content=\"0; url=agglayer\">" > target/doc/index.html
          cp -r target/doc/* ./host-docs

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: "host-docs/"
          retention-days: 7

  deploy-gh-pages:
    name: Deploy to GitHub Pages
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Download documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: host-docs

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3.0.0
        with:
          path: "host-docs/"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-cloudflare:
    name: Deploy to Cloudflare Workers
    needs: build
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: docs

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Create worker script
        run: |
          cat > index.js << 'EOF'
          import { getAssetFromKV, mapRequestToAsset } from '@cloudflare/kv-asset-handler'

          export default {
            async fetch(request, env, ctx) {
              try {
                // Handle root path redirect to agglayer docs
                const url = new URL(request.url)
                if (url.pathname === '/') {
                  return Response.redirect(`${url.origin}/agglayer/`, 301)
                }

                const options = {
                  mapRequestToAsset: req => {
                    // Handle trailing slashes for directory index files
                    if (req.url.endsWith('/')) {
                      return mapRequestToAsset(new Request(req.url + 'index.html', req))
                    }
                    return mapRequestToAsset(req)
                  }
                }

                return await getAssetFromKV(request, options)
              } catch (e) {
                // Fallback for missing files
                if (e.status === 404) {
                  return new Response('Documentation not found', { 
                    status: 404,
                    headers: { 'content-type': 'text/html' }
                  })
                }
                return new Response('Error: ' + e.message, { status: 500 })
              }
            }
          }
          EOF

      - name: Create package.json
        run: |
          cat > package.json << 'EOF'
          {
            "name": "agglayer-rust-docs",
            "version": "1.0.0",
            "dependencies": {
              "@cloudflare/kv-asset-handler": "^0.3.0"
            }
          }
          EOF

      - name: Install dependencies
        run: npm install

      - name: Update wrangler.toml for PR
        run: |
          sed "s/{{PR_NUMBER}}/${{ github.event.number }}/g" wrangler.toml.template > wrangler.toml

      - name: Deploy to Cloudflare Workers
        run: wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_WORKER_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_WORKER_ACCOUNT_ID }}

      - name: Comment PR with deployment URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“– Documentation deployed to: https://pr${{ github.event.number }}.rust-docs.agglayer.dev`
            })

  cleanup-cloudflare:
    name: Cleanup Cloudflare deployment
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Delete worker
        run: |
          wrangler delete agglayer-rust-docs-pr${{ github.event.number }} --force || echo "Worker may not exist"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_WORKER_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_WORKER_ACCOUNT_ID }}
